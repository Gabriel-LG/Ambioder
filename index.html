<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="description" content="Ambioder : Alternative firmware for Ikea's Dioder, providing Ambient Lighting" />

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>Ambioder</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/Gabriel-LG/Ambioder">View on GitHub</a>

          <h1 id="project_title">Ambioder</h1>
          <h2 id="project_tagline">Alternative firmware for Ikea's Dioder, providing Ambient Lighting</h2>

            <section id="downloads">
              <a class="zip_download_link" href="https://github.com/Gabriel-LG/Ambioder/zipball/master">Download this project as a .zip file</a>
              <a class="tar_download_link" href="https://github.com/Gabriel-LG/Ambioder/tarball/master">Download this project as a tar.gz file</a>
            </section>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <p><a href="http://youtu.be/GyrZ5HvOXz0"><img src="https://raw.github.com/wiki/gabriel-lg/Ambioder/images/video.png" alt="Ambioder demonstration video"></a><br>
All you need is a very small hardware modification (5 wires), a 5V RS232 port and (access to) a PIC programmer.<br><em><strong>WARNING:</strong></em> after reprogramming your Dioder, its original functionality will be lost.<br>
Download the .hex file for the PIC programmer <a href="https://raw.github.com/wiki/gabriel-lg/Ambioder/binaries/Ambioder_v1.0.hex">here</a>.</p>

<h2>Intro</h2>

<p>Sometime ago I purchased a Dioder LED light from Ikea, with the intention to create an Ambient Lighting device for my mediacentre. I saw that there were numerous Dioder hacks around, including an Ambient Lighting hack. However most hacks require an extra MCU, or perform a complete brain transplant. I figured that Dioder's brains are powerful enough for some Ambient Lighting.<br>
I found three projects that were really helpful; first of all <a href="http://christian.amsuess.com/tutorials/threebutton_dioder/">Christian Amsüss' Dioder++ project</a> that actually provided the hardware modifications I used for my hack. Also <a href="http://code.google.com/p/boblight/">the Boblight project by Bob Loosen</a>, that supplied me with ready-made Ambient Lighting software for my mediacentre.<br>
Also I would like to mention  <a href="http://www.vagrearg.org/content/skilt20">the OSAA Skilt 2.0 project by Vagrearg</a>, this project provided me with the schematics of the Dioder's internal hardware and a benchmark ;-)<br>
I decided to name my project “Ambioder”, as a combination of Ambient lighting and Dioder.</p>

<h2>About the Dioder</h2>

<p>The Dioder (3-button version) consists of a power supply, 4 led bars each containing 9 pretty bright RGB LEDs, some fixtures and a control unit. The interesting part is the control unit, which is build around a Microchip PIC16F684 microcontroller. The PIC generates 3 PWM signals (Red, Green and Blue) which are amplified by 3 FETs, to power the RGB LEDs. A potmeter is connected to an AD convertor attached to a colorwheel. There are also 3 buttons attached to GPIO lines.<br>
So I hooked up my old oscilloscope to the Dioder to see what Ikea's software was capable of. It turns out that rotating the color wheel, only fades one channel at a time (the other two are kept either on or off). The PWM period is exactly 1kHz and is divided in 20 steps (providing 21 intensities, including black/off). </p>

<h2>My goals</h2>

<p>What I wanted to achieve, was a simple and cheap solution, providing ambient lighting for your mediacenter. I also wanted to keep the hardware modifications to a minimum, in order to keep this solution accessible to (almost) everyone.<br>
The quality of the lighting has to be good in terms of number of colors and frequency. Also the interface to the mediacenter has to be very responsive and reliable.</p>

<h2>The hardware</h2>

<p>To turn your Dioder into an Ambioder, all you need to do is <a href="http://christian.amsuess.com/tutorials/threebutton_dioder/">solder the ICSP port (5 wires) onto the Dioder PCB</a> and reprogram it. The hex file for reprogramming can be downloaded <a href="https://raw.github.com/wiki/gabriel-lg/Ambioder/binaries/Ambioder_TTL_v1.0.hex">here</a>.<br>
To communicate with your Ambioder, you will need a USB TTL-RS232 adapter (<a href="http://dx.com/p/pl2303-mini-usb-to-ttl-uart-communication-module-board-blue-161543">like this one</a>, or <a href="http://dx.com/p/pl2303hx-usb-to-ttl-converter-module-149859">this one</a>).  </p>

<p>Connect the USB-RS232 controller to the ICSP port you previously soldered to the Dioder PCB. Pin 5 of the serial port (gnd) goes to pin 3 (Vss) of the ICSP port. Pin 3 of the serial port (tx) goes to pin 1 (Vpp) of the ICSP.<br><img src="https://raw.github.com/wiki/gabriel-lg/Ambioder/images/ICSP.png" alt="ICSP"></p>

<p><em>Alternatively, you can use a <strong>CHEAP</strong> USB serial port, <a href="http://dx.com/p/usb-to-rs232-adapter-with-usb-extension-cable-41cm-length-24799">like I did</a>; The reason it has to be cheap, is because the higher quality ones contain an RS-232 level-shifter. The -5 to -15V signal generated by the level-shifter <strong>could damage the microcontroller</strong>! You will need <a href="https://raw.github.com/wiki/gabriel-lg/Ambioder/binaries/Ambioder_v1.0.hex">this version</a> of the Ambioder firmware for use with a USB serial port.
<img src="https://raw.github.com/wiki/gabriel-lg/Ambioder/images/Ambioder_hw.jpg" alt="hardware"><strong>WARNING:</strong> Do not use the serial port on your motherboard, it most certainly contains a level-shifter!</em>     </p>

<h2>The PIC software</h2>

<p>The PIC software was a lot more difficult; the PIC16F684 does not contain a UART controller, it also does not contain a PWM controller. Since I want the UART to be 100% reliable and the PWM to be 100% stable, the absence of these components provided a challenge.<br>
Luckily the PIC16F684 does come with an interrupt controller and a timer/comparator interrupt source, I use this to poll the serial port and step the PWM at a regular interval.<br>
Ambioder uses the PIC16F684 internal oscillator at 8Mhz, resulting in 2 million instructions per second. This might sound like a lot, but is actually pretty tight...</p>

<h3>Design</h3>

<p>I designed the PIC software to run as two concurrent loops.<br>
The IO-loop is executed with every timer interrupt. It starts by latching the I/O pins (to ensure constant timing), it then steps the PWM generator and samples the UART RX-line.<br>
The main-loop gathers the received bytes from the UART. After a complete sequence is received, it will pass the received PWM period and R/G/B dutycycles PWM generator.<br>
These two loops interface with each-other using a few shared variables.
<img src="https://raw.github.com/wiki/gabriel-lg/Ambioder/images/Ambioder_design.png" alt="design"></p>

<h3>Serial protocol</h3>

<p>The main-loop will look for a sequence of the following bytes (hex):<br><code>[0x0X 0x1X] 0x2X 0x3X 0x4X 0x5X 0x6X 0x7X</code><br>
The most significant nibble contains the address, the least significant nibble contains the data</p>

<ul>
<li>address 0: pwm period, most significant nibble</li>
<li>address 1: pwm period, least significant nibble</li>
<li>address 2: pwm red, most significant nibble</li>
<li>address 3: pwm red, least significant nibble</li>
<li>address 4: pwm green, most significant nibble</li>
<li>address 5: pwm green, least significant nibble</li>
<li>address 6: pwm blue, most significant nibble</li>
<li>address 7: pwm blue, least significant nibble</li>
</ul><p>The PWM period is optional and will remain unchanged if it was not received. 
After receiving the entire sequence, the PWM period and Red/Green/Blue values are passed to the PWM generator and the main-loop restarts.
Every UART error or unexpected RX byte, will result in the main-loop restarting.</p>

<h3>Implementation</h3>

<p>My implementation provides a UART receiver, an RGB PWM generator and a main-loop implementing my protocol.<br>
The UART receiver functions at 19200/8N1, with a 1-byte buffer.
The RGB PWM generator can generate anything from 16 Million colors at 224Hz, to 4096 colors at 3.8kHz. The PWM generator is also buffered, so it will never flicker when changing colors.    </p>

<h2>The boblight implementation</h2>

<p>To control the Ambioder device, <a href="https://github.com/Gabriel-LG/boblight-ambioder">I extended the Boblight project with Ambioder support.</a>  </p>

<h1>The result</h1>

<p>I have installed the Ambioder on my mediacentre and tested it for a few days now. I am very pleased with the results. It works reliable, the PWM frequency is good and it produces very nice colors.</p>

<p>Excited about Ambioder? <a href="https://www.paypal.com/cgi-bin/webscr?cmd=_donations&amp;business=4S8Y7WJ2YKSYW&amp;lc=GB&amp;item_name=Ambioder&amp;currency_code=EUR&amp;bn=PP%2dDonationsBF%3abtn_donate_SM%2egif%3aNonHosted">Buy me a beer!</a></p>
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">Ambioder maintained by <a href="https://github.com/Gabriel-LG">Gabriel-LG</a></p>
        <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

              <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-39418318-1");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>


  </body>
</html>
